#!/usr/bin/env node

/**
 * Creates package manifest files for 'dist' and 'dist-dev'
 *
 * @author Anders Evenrud <andersevenrud@gmail.com>
 */

var _fs   = require('fs'),
    _path = require('path');

function get_metadata(path, file) {
  var json_path = _path.join(path, "metadata.json");
  if ( _fs.existsSync(json_path) ) {
    try {
      var manifest = JSON.parse(_fs.readFileSync(json_path));

      console.log("- Added theme '%s'", file);

      return manifest;
    } catch ( e ) {
      console.log("- \033[0;31mSkipped '%s' (parse error)\033[0m", file);
      console.error(e);
    }
  }
  return null;
}

function scan_themes(pkgdir) {
  var files = _fs.readdirSync(pkgdir);
  var file, path, metadata;
  var result = [];
  for ( var f = 0; f < files.length; f++ ) {
    file = files[f];
    if ( !file.length || file.match(/^\./) ) continue;

    path = _path.join(pkgdir, file);
    if ( _fs.statSync(path).isDirectory() ) {
      metadata = get_metadata(path, file);
      if ( metadata !== null ) {
        result.push(metadata);
      }
    }
  }
  return result;
}

function create_dist_manifest(dist) {
  console.log("\033[1;32mCreating theme manifest for '%s'\033[0m", dist);

  var combined = scan_themes(dist + "/themes", combined);

  _fs.writeFileSync(dist + "/themes.json", JSON.stringify(combined, null, 2));
}

create_dist_manifest("dist");
create_dist_manifest("dist-dev");
